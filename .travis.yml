sudo: false
dist: trusty
language: node_js
node_js:
  - node

matrix:
  include:
    - env: TYPE="unit"
    - env: TYPE="integration" ATOM_CHANNEL="stable"
    - env: TYPE="integration" ATOM_CHANNEL="beta"

cache:
  directories:
    - node_modules

branches:
  except:
    - gh-pages

notifications:
  email:
    on_success: change
    on_failure: always

before_install:
  - if [ "$TYPE" == "unit" ]; then npm install -g codecov greenkeeper-lockfile; fi

before_script:
  - if [ "$TYPE" == "unit" ]; then greenkeeper-lockfile-update; fi
  - if [ "$TYPE" == "integration" ]; then
      npm run build;
      cd spec/integration;
      curl -s -O https://raw.githubusercontent.com/atom/ci/master/build-package.sh;
      chmod u+x build-package.sh;
      fi

script:
  - if [ "$TYPE" == "unit" ]; then npm run lintdir -- src; fi
  - if [ "$TYPE" == "unit" ]; then npm run lintdir -- spec; fi
  - if [ "$TYPE" == "unit" ]; then (for dir in examples/*; do if [ -d "${dir}" ]; then cd "${dir}"; npm install; npm run lint; if [ $? -ne 0 ]; then exit 1; fi; cd ..; fi; done); fi
  - if [ "$TYPE" == "unit" ]; then npm run coverage; fi
  - if [ "$TYPE" == "integration" ]; then ./build-package.sh; fi

after_script:
  - if [ "$TYPE" == "unit" ]; then codecov; greenkeeper-lockfile-upload; fi
